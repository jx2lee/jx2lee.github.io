<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jx2lee.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"Z4A3UF1R2X","apiKey":"dee49d5f8367c0f900b64906cfe42f19","indexName":"my_blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="K8s cluster는 Master 3대(k8s-master&#x2F;k8s-node1&#x2F;k8s-node2) &#x2F; Worker 2대(k8s-node3&#x2F;k8s-node4)로 구성한다. k8s는 1.15.3 version 으로 진행하며, 모든 서버는 ubuntu 18.04 이다. Update Note  2020.02.25 : kubeadm init 시 --upload-ce">
<meta property="og:type" content="article">
<meta property="og:title" content="[Cloud] K8s cluster 구축">
<meta property="og:url" content="https://jx2lee.github.io/cloud-install_k8s/index.html">
<meta property="og:site_name" content="jx2lee 블로그">
<meta property="og:description" content="K8s cluster는 Master 3대(k8s-master&#x2F;k8s-node1&#x2F;k8s-node2) &#x2F; Worker 2대(k8s-node3&#x2F;k8s-node4)로 구성한다. k8s는 1.15.3 version 으로 진행하며, 모든 서버는 ubuntu 18.04 이다. Update Note  2020.02.25 : kubeadm init 시 --upload-ce">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-21T15:00:00.000Z">
<meta property="article:modified_time" content="2020-04-10T02:58:24.631Z">
<meta property="article:author" content="Jaejun Lee">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jx2lee.github.io/cloud-install_k8s/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>[Cloud] K8s cluster 구축 | jx2lee 블로그</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <!-- Google AdSense start -->
  <script data-ad-client="ca-pub-2024744229492552" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- Google AdSense end -->
  <meta name="google-site-verification" content="mt-wza5WUtvq1j8P-WsZN7mrSgXgOawPOdnhsjdlUGg" />
<link rel="alternate" href="/rss2.xml" title="jx2lee 블로그" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jx2lee 블로그</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">focusing@</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jx2lee.github.io/cloud-install_k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jaejun Lee">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jx2lee 블로그">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Cloud] K8s cluster 구축
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-22 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-22T00:00:00+09:00">2020-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-10 11:58:24" itemprop="dateModified" datetime="2020-04-10T11:58:24+09:00">2020-04-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/cloud-install_k8s/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="cloud-install_k8s/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>K8s cluster는 Master 3대<em>(k8s-master/k8s-node1/k8s-node2)</em> / Worker 2대<em>(k8s-node3/k8s-node4)</em>로 구성한다.</p>
<p>k8s는 <code>1.15.3</code> version 으로 진행하며, 모든 서버는 <code>ubuntu 18.04</code> 이다.</p>
<p><strong>Update Note</strong></p>
<ul>
<li>2020.02.25 : kubeadm init 시 <code>--upload-certs</code> 옵션 부가 설명</li>
<li>2020.03.12 : Calico CNI 설정 추가</li>
<li>2020.03.17 : Trouble shooting 추가 - Calico node not working </li>
</ul>
<a id="more"></a>

<h1 id="공통"><a href="#공통" class="headerlink" title="공통"></a>공통</h1><p>모든 노드에 공통으로 수행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y apt-transport-https curl</span><br><span class="line">apt-get update</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - <span class="comment"># Docker 공식 GPG key</span></span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">    <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">    <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">    stable"</span></span><br><span class="line">apt-get install -y docker-ce</span><br></pre></td></tr></table></figure>

<p>1.15.3 버젼에 맞는 kubelet / kubeadm / kubectl 를 설치한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line"><span class="built_in">echo</span> deb http://apt.kubernetes.io/ kubernetes-xenial main &gt; /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubeadm=1.15.3-00 kubelet=1.15.3-00 kubectl=1.15.3-00</span><br></pre></td></tr></table></figure>

<p>Kubernets는 swap를 off시켜야 작동하므로 swap 메모리를 끈다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">free</span><br><span class="line">swapoff -a</span><br><span class="line">vi /etc/fstab</span><br><span class="line"><span class="comment"># 재부팅시 자동으로 swapoff 하려면 위 파일에서 swap 부분 주석 처리</span></span><br></pre></td></tr></table></figure>

<p>방화벽을 내려준다 <em>(ubnut : ufw)</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop ufw </span><br><span class="line">systemctl <span class="built_in">disable</span> ufw</span><br></pre></td></tr></table></figure>

<p><code>/etc/docker/daemon.json</code> 의 파일을 수정하고 도커 데몬을 재실행한다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>], <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line"><span class="string">"log-opts"</span>: &#123;</span><br><span class="line"><span class="string">"max-size"</span>: <span class="string">"100m"</span> &#125;,</span><br><span class="line"><span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>, <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.179.185:5000"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>insecure-registries 는 VIP(virtual ip)를 나타내는데, 삼중화 했을 때 마스터 간 통신을 위한 ip. 뒤에 포트 5000은 후에 마스터 부분에 설치할 keepalived 에서 사용한다</em><br>Q. VIP의 포트는 아무렇게 지정해도 되는가?</p>
</blockquote>
<p>위 커맨드 라인을 정리한 script는 다음과 같다. 해당 스크립트를 작성하여 5개 노드에서 모두 실행한다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># install basic package &amp; docker-ce &amp; k8s utils</span></span><br><span class="line"></span><br><span class="line">apt-get install -y apt-transport-https curl</span><br><span class="line">apt-get update</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - <span class="comment"># Docker 공식 GPG key</span></span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">  <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">  stable"</span></span><br><span class="line">apt-get install -y docker-ce</span><br><span class="line"></span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line"><span class="built_in">echo</span> deb http://apt.kubernetes.io/ kubernetes-xenial main &gt; /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubeadm=1.15.3-00 kubelet=1.15.3-00 kubectl=1.15.3-00</span><br><span class="line"></span><br><span class="line">free</span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line">ufw <span class="built_in">disable</span></span><br><span class="line">ufw status</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>], <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line"><span class="string">"log-opts"</span>: &#123;</span><br><span class="line"><span class="string">"max-size"</span>: <span class="string">"100m"</span> &#125;,</span><br><span class="line"><span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>, <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.179.185:5000"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; <span class="built_in">echo</span> <span class="string">"restart docker-daemon"</span></span><br><span class="line">systemctl restart docker &amp;&amp; <span class="built_in">echo</span> <span class="string">"restart docker"</span></span><br></pre></td></tr></table></figure>

<h1 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h1><p>마스터 노드에서만 진행하는 부분을 다룬다</p>
<h2 id="Keepalived-설치"><a href="#Keepalived-설치" class="headerlink" title="Keepalived 설치"></a>Keepalived 설치</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y keepalived</span><br><span class="line">vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<p><code>keepalived.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s8</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 100 <span class="comment"># 이후 마스터부터 1씩 감소하여 수정</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass $ place secure password here.</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.179.185</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>interface : ifconfig -a로 확인</li>
<li>priority : master 마다 다른 값 설정<ul>
<li>priority 값이 높으면 최우선적으로 master 역할 수행</li>
<li>100, 99, 98 로 설정</li>
</ul>
</li>
<li>virtual_ipaddress : 앞전에 docker daemon의 vip 주소 기입<ul>
<li>VIP 이어도 아무 ip나 사용하면 혹여나 충돌이 일어날까봐 할당받은 ip 사용</li>
</ul>
</li>
</ul>
<p>keepalived 서비스 재시작 후 상태(<code>ip a</code>)를 확인한다</p>
<p><code>systemctl restart keepalived &amp;&amp; systemctl status keepalived</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">3: enp6s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 64:e5:99:fa:52:c1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.179.172/24 brd 192.168.179.255 scope global enp6s0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.179.185/32 scope global enp6s0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::66e5:99ff:fefa:52c1/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>VIP로 설정한 192.168.179.171 이 보이는 것을 확인 // 하나의 master에만 보임 (나머지는 stand by)</em></p>
</blockquote>
<h2 id="K8s-설치"><a href="#K8s-설치" class="headerlink" title="K8s 설치"></a>K8s 설치</h2><p><code>kubeadm-config.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: <span class="string">"v1.15.3"</span></span><br><span class="line">controlPlaneEndpoint: <span class="string">"192.168.179.185:6443"</span></span><br><span class="line">networking:</span><br><span class="line">    serviceSubnet: <span class="string">"10.96.0.0/16"</span></span><br><span class="line">    podSubnet: <span class="string">"10.244.0.0/16"</span></span><br><span class="line">apiServer:</span><br><span class="line">    extraArgs:</span><br><span class="line">        advertise-address: <span class="string">"192.168.179.185”</span></span><br></pre></td></tr></table></figure>

<ul>
<li>위 Yaml 파일은 첫 번째 master에서만 작성 후 init 을 수행한다.</li>
<li>v1.15.3으로 작성한다.</li>
</ul>
<blockquote>
<p><em>controlPlaneEndpoint와 advertise-address 는 VIP이고 포트로 6443으로 지정</em></p>
</blockquote>
<p>Yaml 파일을 이용해 클러스터 초기화를 진행한다.</p>
<p><code>kubeadm init --config=kubeadm-config.yaml --upload-certs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of the control-plane node running the following <span class="built_in">command</span> on each as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.179.185:6443 --token iicz2g.0a8b07vasikwuthz \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:249ee21a200d807f21dad0102eb638e50904102c7e7ae8f6388c1654f60ae1a0 \</span><br><span class="line">    --control-plane --certificate-key 553c75881e6825bf9e5f3887b2100de4a3d979777a313b70281c5bbe5ddeef80</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted <span class="keyword">in</span> two hours; If necessary, you can use </span><br><span class="line"><span class="string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.179.185:6443 --token iicz2g.0a8b07vasikwuthz \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:249ee21a200d807f21dad0102eb638e50904102c7e7ae8f6388c1654f60ae1a0</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em><code>--upload-certs</code> 옵션은 Master 이중화 시 key 인증을 init 명령과 수행해주는 역할을 한다. 이 옵션을 주지 않으면 이중화 대상 Master 에 key 인증을 수행해야 한다.</em></p>
</blockquote>
<p>서버 주소 및 인증서를 복사하는 단계로 아래 명령어를 수행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<p><code>kubectl get pods --all-namespaces</code> 명령어로 아래와 같은 파드가 생성되기 기다린다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~<span class="comment"># kgpo --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-5c98db65d4-9fpzf             0/1     Pending   0          3m2s</span><br><span class="line">kube-system   coredns-5c98db65d4-vn8d5             0/1     Pending   0          3m2s</span><br><span class="line">kube-system   etcd-k8s-master                      1/1     Running   0          119s</span><br><span class="line">kube-system   kube-apiserver-k8s-master            1/1     Running   0          2m14s</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   1/1     Running   0          2m21s</span><br><span class="line">kube-system   kube-proxy-c4cnn                     1/1     Running   0          3m1s</span><br><span class="line">kube-system   kube-scheduler-k8s-master            1/1     Running   0          2m7s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>coredns 는 CNI를 설치해야 Running 상태가 된다.</em></p>
</blockquote>
<p><a href="https://docs.projectcalico.org/v3.9/manifests/calico.yaml" target="_blank" rel="noopener">calico yaml</a>을 다운받아 <code>CALICO_IPV4POOL_CIDR</code> 값을 10.244.0.0/16 으로 변경한 후 CNI 를 설치한다.</p>
<p><code>kubectl apply -f kube-calico.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">        - name: calico-node</span><br><span class="line">          image: calico/node:v3.9.5</span><br><span class="line">          env:</span><br><span class="line">            <span class="comment"># Use Kubernetes API as the backing datastore.</span></span><br><span class="line">            - name: DATASTORE_TYPE</span><br><span class="line">              value: <span class="string">"kubernetes"</span></span><br><span class="line">            <span class="comment"># Wait for the datastore.</span></span><br><span class="line">            - name: WAIT_FOR_DATASTORE</span><br><span class="line">              value: <span class="string">"true"</span></span><br><span class="line">            <span class="comment"># Set based on the k8s node name.</span></span><br><span class="line">            - name: NODENAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: spec.nodeName</span><br><span class="line">            <span class="comment"># Choose the backend to use.</span></span><br><span class="line">            - name: CALICO_NETWORKING_BACKEND</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: calico_backend</span><br><span class="line">            <span class="comment"># Cluster type to identify the deployment type</span></span><br><span class="line">            - name: CLUSTER_TYPE</span><br><span class="line">              value: <span class="string">"k8s,bgp"</span></span><br><span class="line">            <span class="comment"># Auto-detect the BGP IP address.</span></span><br><span class="line">            - name: IP</span><br><span class="line">              value: <span class="string">"autodetect"</span></span><br><span class="line">            <span class="comment"># Enable IPIP</span></span><br><span class="line">            - name: CALICO_IPV4POOL_IPIP</span><br><span class="line">              value: <span class="string">"Always"</span></span><br><span class="line">            <span class="comment"># Set MTU for tunnel device used if ipip is enabled</span></span><br><span class="line">            - name: FELIX_IPINIPMTU</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: veth_mtu</span><br><span class="line">            <span class="comment"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span></span><br><span class="line">            <span class="comment"># chosen from this range. Changing this value after installation will have</span></span><br><span class="line">            <span class="comment"># no effect. This should fall within `--cluster-cidr`.</span></span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: <span class="string">"10.244.0.0/16"</span> <span class="comment">######################## 변경 ########################</span></span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>CALICO_IPV4POOL_CIDR 값을 10.244.0.0/16 으로 변경되어있는지 확인한 후 배포한다. 클러스터 구성한 노드 IP 대역과 같으면 충돌이 일어난다고 한다.</em></p>
</blockquote>
<p>calico 파드가 띄워졌는지 확인한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@k8s-master:~<span class="comment"># kgpo --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-56cd854695-65j42   1/1     Running   0          89s</span><br><span class="line">kube-system   calico-node-ptq8x                          1/1     Running   0          89s</span><br><span class="line">kube-system   coredns-5c98db65d4-9fpzf                   1/1     Running   0          7m29s</span><br><span class="line">kube-system   coredns-5c98db65d4-vn8d5                   1/1     Running   0          7m29s</span><br><span class="line">kube-system   etcd-k8s-master                            1/1     Running   0          6m26s</span><br><span class="line">kube-system   kube-apiserver-k8s-master                  1/1     Running   0          6m41s</span><br><span class="line">kube-system   kube-controller-manager-k8s-master         1/1     Running   0          6m48s</span><br><span class="line">kube-system   kube-proxy-c4cnn                           1/1     Running   0          7m28s</span><br><span class="line">kube-system   kube-scheduler-k8s-master                  1/1     Running   0          6m34s</span><br></pre></td></tr></table></figure>

<p>나머지 master node에서 init 시 생성된 커맨드를 실행하여 클러스터에 Join 한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.179.185:6443 --token iicz2g.0a8b07vasikwuthz \</span><br><span class="line"> --discovery-token-ca-cert-hash sha256:249ee21a200d807f21dad0102eb638e50904102c7e7ae8f6388c1654f60ae1a0 \</span><br><span class="line"> --control-plane --certificate-key 553c75881e6825bf9e5f3887b2100de4a3d979777a313b70281c5bbe5ddeef80</span><br></pre></td></tr></table></figure>

<p>마찬가지로 서버 주소 및 인증서를 복사하는 명령어를 수행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>

<h1 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h1><p>kubeadm init 시 나온 토큰과 해쉬값으로 각 워커 노드에서 Join 한다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.179.185:6443 --token iicz2g.0a8b07vasikwuthz \</span><br><span class="line"> --discovery-token-ca-cert-hash sha256:249ee21a200d807f21dad0102eb638e50904102c7e7ae8f6388c1654f60ae1a0</span><br></pre></td></tr></table></figure>

<h1 id="설치-확인"><a href="#설치-확인" class="headerlink" title="설치 확인"></a>설치 확인</h1><h2 id="Kubectl-get-nodes"><a href="#Kubectl-get-nodes" class="headerlink" title="Kubectl get nodes"></a>Kubectl get nodes</h2><p><code>kubectl get nodes -o wide</code><br>master node에서 확인하면 클러스터에 포함된 노드들을 확인할 수 있다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME         STATUS   ROLES    AGE   VERSION   INTERNAL-IP       EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span><br><span class="line">k8s-master   Ready    master   44m   v1.15.3   192.168.179.172   &lt;none&gt;        Ubuntu 18.04.4 LTS   5.3.0-28-generic    docker://19.3.8</span><br><span class="line">k8s-node1    Ready    master   41m   v1.15.3   192.168.179.173   &lt;none&gt;        Ubuntu 18.04.3 LTS   4.15.0-88-generic   docker://19.3.6</span><br><span class="line">k8s-node2    Ready    master   40m   v1.15.3   192.168.179.174   &lt;none&gt;        Ubuntu 18.04.3 LTS   4.15.0-88-generic   docker://19.3.6</span><br><span class="line">k8s-node3    Ready    &lt;none&gt;   40m   v1.15.3   192.168.179.175   &lt;none&gt;        Ubuntu 18.04.3 LTS   4.15.0-88-generic   docker://19.3.8</span><br><span class="line">k8s-node4    Ready    &lt;none&gt;   40m   v1.15.3   192.168.179.176   &lt;none&gt;        Ubuntu 18.04.3 LTS   4.15.0-88-generic   docker://19.3.8</span><br></pre></td></tr></table></figure>

<h2 id="선택사항-Master-node에도-pod-배포가-가능한-상태로-변환"><a href="#선택사항-Master-node에도-pod-배포가-가능한-상태로-변환" class="headerlink" title="(선택사항) Master node에도 pod 배포가 가능한 상태로 변환"></a>(선택사항) Master node에도 pod 배포가 가능한 상태로 변환</h2><p>master에 Pod를 배포할 수 있는 상태로 변환하기 위해 taint 조건을 해제한다.</p>
<p><code>kubectl taint nodes {node-name} node-role.kubernetes.io/master:NoSchedule-</code></p>
<blockquote>
<p><em>만약 노드를 리스케쥴 되지 않게 복구하려면 kubectl taint nodes {node-name} node-role.kubernetes.io/master:NoSchedule</em></p>
</blockquote>
<h1 id="Trouble-Shooting"><a href="#Trouble-Shooting" class="headerlink" title="Trouble-Shooting"></a>Trouble-Shooting</h1><h2 id="calico-node-가-Running-상태이지만-Unhealthy-문제"><a href="#calico-node-가-Running-상태이지만-Unhealthy-문제" class="headerlink" title="calico node 가 Running 상태이지만 Unhealthy 문제"></a>calico node 가 Running 상태이지만 Unhealthy 문제</h2><p><a href="https://github.com/projectcalico/calico/issues/2904" target="_blank" rel="noopener">https://github.com/projectcalico/calico/issues/2904</a> 문제와 같다. calico-node 가 클러스터 내 노드 수만큼 기동하지만 0/1 Running 상태였다. 문제가 있는 파드를 describe 해본 결과 다음과 같다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason          Age                   From                 Message</span><br><span class="line">  ----     ------          ----                  ----                 -------</span><br><span class="line">  Normal   Pulled          45m                   kubelet, k8s-master  Container image <span class="string">"calico/cni:v3.9.5"</span> already present on machine</span><br><span class="line">  Normal   Created         45m                   kubelet, k8s-master  Created container upgrade-ipam</span><br><span class="line">  Normal   Started         45m                   kubelet, k8s-master  Started container upgrade-ipam</span><br><span class="line">  Normal   Scheduled       45m                   default-scheduler    Successfully assigned kube-system/calico-node-v5rgk to k8s-master</span><br><span class="line">  Normal   Started         45m                   kubelet, k8s-master  Started container install-cni</span><br><span class="line">  Normal   Pulled          45m                   kubelet, k8s-master  Container image <span class="string">"calico/cni:v3.9.5"</span> already present on machine</span><br><span class="line">  Normal   Created         45m                   kubelet, k8s-master  Created container install-cni</span><br><span class="line">  Normal   Started         45m                   kubelet, k8s-master  Started container flexvol-driver</span><br><span class="line">  Normal   Pulled          45m                   kubelet, k8s-master  Container image <span class="string">"calico/pod2daemon-flexvol:v3.9.5"</span> already present on machine</span><br><span class="line">  Normal   Created         45m                   kubelet, k8s-master  Created container flexvol-driver</span><br><span class="line">  Normal   Pulled          45m                   kubelet, k8s-master  Container image <span class="string">"calico/node:v3.9.5"</span> already present on machine</span><br><span class="line">  Normal   Created         45m                   kubelet, k8s-master  Created container calico-node</span><br><span class="line">  Normal   Started         45m                   kubelet, k8s-master  Started container calico-node</span><br><span class="line">  Warning  Unhealthy       30m (x34 over 45m)    kubelet, k8s-master  Readiness probe failed: calico/node is not ready: felix is not ready: readiness probe reporting 503</span><br><span class="line">  Warning  Unhealthy       25m (x76 over 45m)    kubelet, k8s-master  Readiness probe failed: calico/node is not ready: felix is not ready: Get http://localhost:9099/readiness: dial tcp 127.0.0.1:9099: connect: connection refused</span><br><span class="line">  Warning  Unhealthy       15m (x116 over 45m)   kubelet, k8s-master  Liveness probe failed: calico/node is not ready: Felix is not live: Get http://localhost:9099/liveness: dial tcp 127.0.0.1:9099: connect: connection refused</span><br><span class="line">  Warning  FailedMount     12m                   kubelet, k8s-master  MountVolume.SetUp failed <span class="keyword">for</span> volume <span class="string">"calico-node-token-9j8gt"</span> : couldn<span class="string">'t propagate object cache: timed out waiting for the condition</span></span><br><span class="line"><span class="string">  Normal   SandboxChanged  12m                   kubelet, k8s-master  Pod sandbox changed, it will be killed and re-created.</span></span><br><span class="line"><span class="string">  Normal   Pulled          12m                   kubelet, k8s-master  Container image "calico/cni:v3.9.5" already present on machine</span></span><br><span class="line"><span class="string">  Normal   Started         12m                   kubelet, k8s-master  Started container upgrade-ipam</span></span><br><span class="line"><span class="string">  Normal   Created         12m                   kubelet, k8s-master  Created container upgrade-ipam</span></span><br><span class="line"><span class="string">  Normal   Started         12m (x2 over 12m)     kubelet, k8s-master  Started container install-cni</span></span><br><span class="line"><span class="string">  Normal   Pulled          12m (x2 over 12m)     kubelet, k8s-master  Container image "calico/cni:v3.9.5" already present on machine</span></span><br><span class="line"><span class="string">  Normal   Created         12m (x2 over 12m)     kubelet, k8s-master  Created container install-cni</span></span><br><span class="line"><span class="string">  Normal   Started         12m                   kubelet, k8s-master  Started container flexvol-driver</span></span><br><span class="line"><span class="string">  Normal   Pulled          12m                   kubelet, k8s-master  Container image "calico/pod2daemon-flexvol:v3.9.5" already present on machine</span></span><br><span class="line"><span class="string">  Normal   Created         12m                   kubelet, k8s-master  Created container flexvol-driver</span></span><br><span class="line"><span class="string">  Normal   Pulled          12m                   kubelet, k8s-master  Container image "calico/node:v3.9.5" already present on machine</span></span><br><span class="line"><span class="string">  Normal   Created         12m                   kubelet, k8s-master  Created container calico-node</span></span><br><span class="line"><span class="string">  Normal   Started         12m                   kubelet, k8s-master  Started container calico-node</span></span><br><span class="line"><span class="string">  Warning  Unhealthy       11m (x2 over 12m)     kubelet, k8s-master  Readiness probe failed: calico/node is not ready: felix is not ready: readiness probe reporting 503</span></span><br><span class="line"><span class="string">  Warning  Unhealthy       7m34s (x19 over 12m)  kubelet, k8s-master  Liveness probe failed: calico/node is not ready: Felix is not live: Get http://localhost:9099/liveness: dial tcp 127.0.0.1:9099: connect: connection refused</span></span><br><span class="line"><span class="string">  Warning  Unhealthy       2m30s (x38 over 12m)  kubelet, k8s-master  Readiness probe failed: calico/node is not ready: felix is not ready: Get http://localhost:9099/readiness: dial tcp 127.0.0.1:9099: connect: connection refused</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><em>너무 길어 Event 부분만 작성하였다.</em></p>
</blockquote>
<p>좀 더 deep 한 로그를 찾고자 해당 파드 log 를 찾아본 결과 다음과 같다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2019-10-03 04:34:38.296 [WARNING][16449] int_dataplane.go 781: failed to wipe the XDP state error=failed to load BPF program (/tmp/felix-bpf-824808941): <span class="built_in">stat</span> /sys/fs/bpf/calico/xdp/prefilter_v1_calico_tmp_A: no such file or directory</span><br><span class="line">libbpf: Error <span class="keyword">in</span> bpf_object__probe_name():Operation not permitted(1). Couldn<span class="string">'t load basic '</span>r0 = 0<span class="string">' BPF program.</span></span><br><span class="line"><span class="string">libbpf: failed to load object '</span>/tmp/felix-bpf-824808941<span class="string">'</span></span><br><span class="line"><span class="string">Error: failed to load object file</span></span><br></pre></td></tr></table></figure>

<p>위 깃헙 이슈 링크를 확인해보면 OS 커널단에서 BPF 관련 오브젝트를 읽어드리지 못한 상태였다. 이슈 내용들을 살펴보니 OS secure boot 한 경우 생길 수 있다하며 <code>mokutil --disable-validation</code> 명령어로 안전 모드로 부팅하지 못하게 설정하고 재부팅 하였다. 재부팅 시 명령어로 설정한 패스워드로 secure-mode boot 을 disabled 로 설정하고 재부팅 하니 calico node 가 문제없이 기동됨을 확인하였다.</p>
<hr>
<p>2020.01.22 made by <em>jaejun.lee</em></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/cloud-introduction_to_kubeflow/" rel="prev" title="[Cloud] Kubeflow overview">
      <i class="fa fa-chevron-left"></i> [Cloud] Kubeflow overview
    </a></div>
      <div class="post-nav-item">
    <a href="/cloud-install_kubeflow/" rel="next" title="[Cloud] Kubeflow 설치">
      [Cloud] Kubeflow 설치 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#공통"><span class="nav-number">1.</span> <span class="nav-text">공통</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Master-Node"><span class="nav-number">2.</span> <span class="nav-text">Master Node</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived-설치"><span class="nav-number">2.1.</span> <span class="nav-text">Keepalived 설치</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#K8s-설치"><span class="nav-number">2.2.</span> <span class="nav-text">K8s 설치</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Worker-Node"><span class="nav-number">3.</span> <span class="nav-text">Worker Node</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#설치-확인"><span class="nav-number">4.</span> <span class="nav-text">설치 확인</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubectl-get-nodes"><span class="nav-number">4.1.</span> <span class="nav-text">Kubectl get nodes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#선택사항-Master-node에도-pod-배포가-가능한-상태로-변환"><span class="nav-number">4.2.</span> <span class="nav-text">(선택사항) Master node에도 pod 배포가 가능한 상태로 변환</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Trouble-Shooting"><span class="nav-number">5.</span> <span class="nav-text">Trouble-Shooting</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#calico-node-가-Running-상태이지만-Unhealthy-문제"><span class="nav-number">5.1.</span> <span class="nav-text">calico node 가 Running 상태이지만 Unhealthy 문제</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Jaejun Lee</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jaejuning" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jaejuning" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jaejun.lee.1991@gmail.com" title="E-Mail → mailto:jaejun.lee.1991@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jaejun Lee</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://jjlee.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://jx2lee.github.io/cloud-install_k8s/";
    this.page.identifier = "cloud-install_k8s/";
    this.page.title = "[Cloud] K8s cluster 구축";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://jjlee.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
